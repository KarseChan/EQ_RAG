import os
from langchain_community.chat_models import ChatTongyi
from langchain.agents import create_agent

# è‡ªå®šä¹‰æ¨¡å—
from config import GRAPH_NAME
from tools import execute_cypher_query

# --- 1. åˆå§‹åŒ–æ¨¡å‹ ---
llm = ChatTongyi(model_name="qwen-max", temperature=0)

# --- 2. å‡†å¤‡å·¥å…· ---
tools = [execute_cypher_query]

# --- 3. å®šä¹‰ Prompt ---
system_prompt = f"""
ä½ æ˜¯ä¸€ä¸ª Apache AGE å›¾æ•°æ®åº“ä¸“å®¶ã€‚
å›¾è°± Schema: 
-å›¾åç§° {GRAPH_NAME}
-èŠ‚ç‚¹æ ‡ç­¾ :æ ¸æŸ¥äººã€æ ¸æŸ¥å•ä½ã€é˜²å¾¡åŒºã€æ‰¿ç¾ä½“
-å…³ç³»ç±»å‹ :éš¶å±ã€æ ¸æŸ¥ã€é˜²å¾¡åŒºæ‰¿ç¾ä½“å…³ç³»

- **ã€é‡è¦å±æ€§è§„åˆ™ã€‘**: 
1. **åç§°/åå­—æŸ¥è¯¢**: ç”¨æˆ·è¾“å…¥åç§°ï¼ˆå¦‚å¼ ä¸‰ã€AåŒºï¼‰æ—¶ï¼Œå±æ€§é”®**å›ºå®šä¸º 'å§“å'**ã€‚
   - ç¤ºä¾‹: "æ‰¾å¼ ä¸‰" -> MATCH (n {{å§“å: 'å¼ ä¸‰'}})
2. **ID æŸ¥è¯¢**: ç”¨æˆ·æä¾› "ID" æˆ– "ç¼–å·" æ—¶ï¼Œå¿…é¡»æ ¹æ®èŠ‚ç‚¹ç±»å‹é€‰æ‹©å¯¹åº”çš„å”¯ä¸€æ ‡è¯†å­—æ®µï¼š
   - é˜²å¾¡åŒº -> å±æ€§é”®ä¸º 'é˜²å¾¡åŒºå”¯ä¸€æ ‡è¯†'
   - æ‰¿ç¾ä½“ -> å±æ€§é”®ä¸º 'æ‰¿ç¾ä½“å”¯ä¸€æ ‡è¯†'
   - æ ¸æŸ¥äºº -> å±æ€§é”®ä¸º 'å§“å' 
   - ç¤ºä¾‹: "IDä¸º123çš„é˜²å¾¡åŒº" -> MATCH (n:é˜²å¾¡åŒº {{é˜²å¾¡åŒºå”¯ä¸€æ ‡è¯†: '123'}})

ã€æ ¸å¿ƒè§„åˆ™ã€‘
1. åªç”Ÿæˆ MATCH/RETURN è¯­å¥ï¼Œä¸¥ç¦ç”Ÿæˆ SQLã€‚
2. **ã€å¼ºåˆ¶ã€‘å˜é‡ç»‘å®šè§„åˆ™**:
   åœ¨ MATCH å­å¥ä¸­ï¼Œ**å¿…é¡»**ä¸ºå…³ç³»æŒ‡å®šå˜é‡åï¼ˆé€šå¸¸ç”¨ `r`ï¼‰ï¼Œ**ä¸¥ç¦**ä½¿ç”¨åŒ¿åå…³ç³»ï¼
   - âŒ é”™è¯¯å†™æ³•: `MATCH (a)-[:æ ¸æŸ¥]->(b)` (ä¼šå¯¼è‡´åé¢æ— æ³•å¼•ç”¨ r)
   - âœ… æ­£ç¡®å†™æ³•: `MATCH (a)-[r:æ ¸æŸ¥]->(b)` (å¿…é¡»æ˜¾å¼å®šä¹‰ r)

3. **ã€å…³é”®ã€‘è¿”å›æ ¼å¼è§„èŒƒ**ï¼š
   - **æŸ¥èŠ‚ç‚¹æ—¶**ï¼šè¿”å›èŠ‚ç‚¹æœ¬èº«ã€‚MATCH (n:æ ¸æŸ¥äºº) RETURN {{node: n}}
   - **æŸ¥å…³ç³»æ—¶**ï¼šå¿…é¡»åŒæ—¶è¿”å›ã€èµ·ç‚¹ã€å…³ç³»ã€ç»ˆç‚¹ã€‘ç»„æˆçš„å®Œæ•´ä¸Šä¸‹æ–‡ã€‚
     âœ… æ­£ç¡®ï¼šMATCH (a)-[r:éš¶å±]->(b) RETURN {{source: a, rel: r, target: b}}
   
4. å¿…é¡»å°†æ‰€æœ‰è¿”å›å­—æ®µå°è£…åœ¨ä¸€ä¸ª Map å¯¹è±¡ä¸­ã€‚
"""

# --- 4. åˆ›å»º Agent (LangGraphç‰ˆ) ---
agent = create_agent(
    model=llm,
    tools=tools,
    system_prompt=system_prompt
)

# --- 5. è¿è¡Œ ---
if __name__ == "__main__":
    print("ğŸš€ Agent (LangGraphç‰ˆ) å¯åŠ¨ä¸­...")

    # æµ‹è¯•é—®é¢˜
    user_question = "441323103033546é˜²å¾¡åŒºæ˜¯è°æ ¸æŸ¥çš„ï¼Ÿ"
    # user_question = "idä¸º441323103033546çš„é˜²å¾¡åŒºæœ‰å“ªäº›æ‰¿ç¾ä½“ï¼Ÿ"
    # user_question = "æœ±ç‚³æ¹–è´Ÿè´£å“ªäº›é˜²å¾¡åŒºï¼Ÿ"
    
    # æ ¹æ®æ–‡æ¡£ï¼Œinvoke æ¥æ”¶ messages åˆ—è¡¨
    # æ ¼å¼: {"messages": [{"role": "user", "content": "..."}]}
    
    input_data = {
        "messages": [
            {"role": "user", "content": user_question}
        ]
    }
    
    print(f"\n-----------------\nç”¨æˆ·æé—®: {input_data['messages'][0]['content']}")
    
    try:
        # result åŒ…å«å®Œæ•´çš„çŠ¶æ€ï¼Œæˆ‘ä»¬éœ€è¦æå–æœ€åä¸€æ¡ AI å›å¤
        result = agent.invoke(input_data)
        
        # æ‰“å°æœ€ç»ˆå›å¤
        last_message = result['messages'][-1]
        print("\n=== æœ€ç»ˆç­”æ¡ˆ ===")
        print(last_message.content)

    except Exception as e:
        print(f"\nâŒ è¿è¡Œå‡ºé”™: {e}")